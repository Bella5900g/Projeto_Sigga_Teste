name: ðŸ§ª CI/CD - Testes Automatizados

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  test:
    name: ðŸš€ Executar Testes E2E
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Instalar dependÃªncias Python
        working-directory: ./app_django
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ—„ï¸ Executar migraÃ§Ãµes do banco de dados
        working-directory: ./app_django
        run: |
          python manage.py migrate --noinput

      - name: ðŸš€ Iniciar servidor Django em background
        working-directory: ./app_django
        run: |
          python manage.py runserver 3000 &
          echo "Servidor Django iniciado na porta 3000"
        env:
          DJANGO_SETTINGS_MODULE: sigga_app.settings

      - name: â³ Aguardar servidor Django estar pronto
        run: |
          echo "â³ Aguardando servidor Django iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/login > /dev/null 2>&1; then
              echo "âœ… Servidor Django estÃ¡ rodando!"
              exit 0
            fi
            echo "Tentativa $i/30 - Aguardando..."
            sleep 2
          done
          echo "âŒ Timeout: Servidor Django nÃ£o iniciou"
          exit 1

      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: automacao_cypress/package-lock.json

      - name: ðŸ“¥ Instalar dependÃªncias do Cypress
        working-directory: ./automacao_cypress
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"

      - name: ðŸ§ª Executar testes Cypress
        working-directory: ./automacao_cypress
        run: |
          echo "ðŸš€ Iniciando execuÃ§Ã£o dos testes E2E..."
          npm test
        env:
          CYPRESS_baseUrl: http://localhost:3000

      - name: ðŸ“Š Upload de vÃ­deos dos testes (se falharem)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: automacao_cypress/cypress/videos
          retention-days: 7

      - name: ðŸ“¸ Upload de screenshots (se falharem)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: automacao_cypress/cypress/screenshots
          retention-days: 7

      - name: âœ… Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸŽ¯ Resultado da ExecuÃ§Ã£o do Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Pipeline executado com sucesso!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Todos os testes E2E passaram! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Pipeline falhou" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Verifique os logs acima para mais detalhes." >> $GITHUB_STEP_SUMMARY
            echo "VÃ­deos e screenshots foram salvos como artefatos." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Etapas Executadas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Checkout do cÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… ConfiguraÃ§Ã£o Python 3.11" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… InstalaÃ§Ã£o de dependÃªncias Django" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… ExecuÃ§Ã£o de migraÃ§Ãµes do banco de dados" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… InicializaÃ§Ã£o do servidor Django (porta 3000)" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… ConfiguraÃ§Ã£o Node.js 18" >> $GITHUB_STEP_SUMMARY
          echo "7. âœ… InstalaÃ§Ã£o de dependÃªncias Cypress" >> $GITHUB_STEP_SUMMARY
          echo "8. âœ… ExecuÃ§Ã£o dos testes E2E" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tempo de execuÃ§Ã£o:** ~2-3 minutos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Testes executados:**" >> $GITHUB_STEP_SUMMARY
          echo "- Fluxo completo: Login + CRUD + Logout" >> $GITHUB_STEP_SUMMARY
          echo "- ValidaÃ§Ã£o de login com credenciais invÃ¡lidas" >> $GITHUB_STEP_SUMMARY

